!function(t){if("undefined"==typeof t.pageflow){t.pageflow=function(e,i){return new t.pageflow.fn.construct(e,i)};var e=t.Template('<li id="guide_{name}" title="{desc}" name="guide_{name}"  stepname={name}  class="{class}" style="{style}"><a href="javascript:void(0);" stepname="{name}"  onclick="">{desc}</a></li>'),i=t.ctx.attr("page"),n='<div class="c_toolTip c_toolTip-bottom" id="pageflow_restart_toolTip" style="height:75px;left:30px;top:auto;display:none;visibility:;"><div class="c_toolTipTop"><div></div></div><div class="c_toolTipContent">'+t.lang["view.web.comp.pageflow.deltip"]+'\t<div class="c_toolTipDelete">\t\t<a href="#nogo" id="pageflow_restart__toolTip_delete">'+t.lang["view.web.comp.pageflow.noshow"]+'</a>\t</div></div><div class="c_toolTipBottom"><div></div></div><div class="c_toolTipPointer" id="pageflow_restart_tipPointer" style="right:auto; left:30px;"></div>\x3c!--[if IE 6]><iframe class="c_toolTipCover"></iframe><![endif]--\x3e</div>';t.pageflow.fn={construct:function(e,i){this.id=e,this.steps=i,this.imgstatus=0,this.active=0,this.activeFrames=[],this.curStep="",this.size=i.length,this.gostep=t.DataMap("{}"),this.drawGuide=!1,this.isFilish=!1,t.extend(this,i)},getName:function(){return this.id},execExpress:function(t,e,i){var n=this.getStepFrame(t);if(n){var s=n("#"+e).val();return null==s||void 0===s?i:s}return i},getTransData:function(e){var i=this.getStep(e);if(null==i||void 0===i)return null;if("begin"==i.name||"end"==i.name||"step"!=i.tagname)return null;var n=this.getStepFrame(i.name);if(n){var s=i.transdata;if(s&&void 0!==s){var a=[],o=n,r=window.getFlow();return t.each(s.split(","),function(e,i){if(i.indexOf("@")>0){var s=i.split("@");n=r.getStepFrame(s[0]),i=s[1]}else n=o;var l=t.trim(i),u=n("#"+l);if(u.length&&(u.isNodeName("input")||u.isNodeName("textarea")||u.isNodeName("select")))a.push(l+"="+encodeURIComponent(u.val()===undefined?"":u.val()));else if(u.length>0){var c=n.ajax.buildPostData(l);""!=c?a.push(c):a.push(l+"={}")}else a.push(l+"={}");a.join("&")}),a.join("&")}}return null},isMonChanged:function(e){var i=this.getStep(e);if(null==i&&void 0===i)return!1;var n=t("#guide_"+i.name),s=n.attr("monitor");return!(!s||""==s)&&s!="{"+this.getStepMonitor(e)+"}"},getStepMonitor:function(e){var i=this.getStep(e);if(null==i&&void 0===i)return null;var n=i.monitor,s=[];if(n){var a=this.getStepFrame(e);if(a)return t.each(n.split(","),function(e,i){var n=a("#"+t.trim(i));if(n.length>0)if(n.val())s.push(t.trim(i)+"="+n.val());else{var o=a.ajax.buildPostData(t.trim(i));s.push(o)}}),n=null,s}return n=null,null},setMonitor:function(e){var i=this.getStep(this.active);if(null==i&&void 0===i)return null;var n=this.getStepMonitor(this.active);if(null!=n){var s=t("#guide_"+i.name);1==e?s.attr("monitor","{"+n+"}"):s.attr("monitor","")}},setGuide:function(i,n){var s=t("#flowguide");if(0==this.drawGuide)s.html(""),this.drawGuide=!0;else{var a=this.getStep(i);if(null==a||void 0===a)return;if("begin"===a.name||"end"===a.name)return;if(i==this.active)return;var o=this.gostep,r=this.active,l=this.firstStep(),u=this.lastStep(),c=!0;t.each(t("li[id^=guide_]",s[0]),function(e,i){var s=t(i),u=s.attr("stepname");"begin"!=u&&"end"!=u&&o.get(u)&&(u==a.name?(0!=n&&t("#guide_"+r).remove(),l&&l==u?s.attr("class","first on"):s.attr("class","on"),c=!1):l&&l==u?s.attr("class","first ok"):s.attr("class","ok"))}),o.get(r)&&c&&(l&&l==i?e.append(s,{name:a.name,desc:a.desc,"class":"first on"}):u&&u.indexOf(i+"|")>-1?e.append(s,{name:a.name,desc:a.desc,"class":"last on"}):e.append(s,{name:a.name,desc:a.desc,"class":"on"}),t("#guide_"+i).bind("click",function(){window.getFlow().backView(this.id.split("_")[1])}))}},firstStep:function(){var e;return t.each(this.steps,function(t,i){"step"==i.tagname&&"begin"===i.name&&(e=i.nextstep)}),e},lastStep:function(){var e;return t.each(this.steps,function(t,i){"step"==i.tagname&&"end"===i.nextstep&&(e+=i.name+"|")}),e},backView:function(e){if(null!=e&&void 0!==e){var i=this.getChange();if(i!=e){if(i&&(t("#guide_"+i).attr("monitor","{"+this.getStepMonitor(i)+"}"),window.confirm(t.lang["view.web.comp.pageflow.confirm"])))return this.reset(i),this.setShowPage(i),void t("#bnext").triggerHandler("click");this.setShowPage(e),this.resetByGuide(e,!1),this.setAutoHeight(),this.curStep=e}}},reset:function(e,i){if(e){if(e!=this.activeFrames.slice(this.activeFrames.length-1)[0]){t("#bback").attr("back");this.resetStatus(e,i);for(var n=this.gostep.indexOfKey(e),s=this.gostep.getCount(),a=s-1;a>n;a--)t("#guide_"+this.gostep.itemAt(a).name).remove(),this.gostep.removeAt(a)}}},resetByGuide:function(t,e){t&&t!=this.active&&this.resetStatus(t,e)},resetStatus:function(e,i){var n=this.getStep(e);if(null!=n&&void 0!==n&&"begin"!==n.name&&"end"!==n.name&&(n.nexttrigger="",this.setGuide(e,i),this.setFlow(e),0!=i)){var s,a,o=t.inArray(e,this.activeFrames);a=o>=0?this.activeFrames.length-o-1:this.activeFrames.length;for(var r=0;r<a;r++)s=this.activeFrames.pop(),t("#"+s).attr("src","about:blank");this.setButton(e),this.active=e,this.curStep=e}},getChange:function(){var t=null;return this.gostep.eachKey(function(e,i){if(window.getFlow().isMonChanged(e))return t=e,!0}),t},setShowPage:function(e){var i=this.firstStep(),n=this.lastStep(),s=this.active,a=this.autoSize();this.setFlow(e),t.each(this.steps,function(){"step"==this.tagname&&(this.name==e?(i&&i==e?t("#guide_"+e).attr("class","first on"):n&&n.indexOf(e+"|")>-1?t("#guide_"+e).attr("class","last on"):t("#guide_"+e).attr("class","on"),t("#"+this.name).attr("height",a),t("#"+this.name).css("display","block")):(this.name==s?n&&n.indexOf(s+"|")>-1?t("#guide_"+s).attr("class","last active"):t("#guide_"+s).attr("class","active"):i&&i==this.name?t("#guide_"+this.name).attr("class","first ok"):t("#guide_"+this.name).attr("class","ok"),t("#"+this.name).css("display","none"),t("#"+this.name).attr("height","0")))})},setFrame:function(e,i){var n=window.Wade_isStopResizeHeight;window.Wade_isStopResizeHeight=!0;var s=this.getStep(e);if(null!=s&&void 0!==s){var a=this.getTransData(this.active),o=this.autoSize(),r=this.isMonChanged(this.active),l=this.activeFrames;if(this.getStep("begin").nextstep==e){var u=window.location.search;if(u){if(0==u.indexOf("?service=")){var c=u.indexOf("&");c>-1&&(u=u.substring(c+1))}0==u.indexOf("&")?i+=u:0==u.indexOf("?")&&u.length>1?i+="&"+u.substring(1):i+="&"+u}}t.each(this.steps,function(e){if(this.name==e){if("about:blank"==t("#"+this.name).attr("src")||1==r){var s=this.name;t("#"+s).bind("load",function(t){window.Wade_isStopResizeHeight=n}),-1==t.inArray(s,l)&&l.push(s),a?t("#"+s).attr("src",t.redirect.buildUrl(this.page,this.listener,"&"+a+i)):t("#"+s).attr("src",t.redirect.buildUrl(this.page,this.listener,i)),a=null,t("#"+s).bind("load",function(){t.disabledButton("bnext",!1),window.getFlow().setAutoHeight();var i=t("#"+s)[0].contentWindow;i&&i.$&&"Exception"==i.$.redirect.getPageName()&&window.getFlow().setButton(e,!0),t(i).bind("resize",function(){window.getFlow().setAutoHeight()})})}else{window.Wade_isStopResizeHeight=n;var s=this.name,u=t("#"+s)[0].contentWindow;u&&u.$&&"Exception"==u.$.redirect.getPageName()&&window.getFlow().setButton(e,!0)}t("#"+this.name).attr("height",o),t("#"+this.name).css("display","")}else t("#"+this.name).attr("height","0"),t("#"+this.name).css("display","none")},[s.name])}},setFlow:function(e){var i=this.getStep(e);if(null!=i&&void 0!==i){var n=t("#flow");if(n.length>0){var s=this.gostep;t.each(t("a[id^=flow_]",n[0]),function(e,n){var a=t(n),o=a.attr("name").substring(5);s.get(o)?o==i.name?a.attr("class","step on"):a.attr("class","step ok"):"judge"!=a.attr("class")&&"start"!=a.attr("class")&&"end"!=a.attr("class")&&a.attr("class","step")})}}},setButton:function(e,i){var n=this.getStep(e);if(null!=n&&void 0!==n){i&&t("#bnext").attr("disabled","disabled"),"end"==n.nextstep?(t("#bnext").attr("class","finish"),t("#bnext").attr("active",e),t("#bnext").attr("uuid",e),t("#bnext").html(t.lang.get("pageflow.button.bfinish")),t("#bnext").attr("next",n.nextstep),t("#bnext").unbind("click"),t("#bnext").bind("click",function(){window.getFlow().submit()}),this.isFilish=!0):(t("#bnext").attr("class",""),t("#bnext").attr("active",e),t("#bnext").attr("uuid","step"),t("#bnext").attr("next",n.nextstep),t("#bnext").html(t.lang.get("pageflow.button.bnext")),t("#bnext").unbind("click"),t("#bnext").bind("click",function(){window.getFlow().next(n.nextstep)}),this.isFilish=!1),i?t.disabledButton("bnext",!0):t.disabledButton("bnext",!1);if(this.getStep("begin").nextstep!=e){t("#bback").css("visibility","visible");var s=null;this.gostep.eachKey(function(t,e){t!=n.name&&(s=t)}),t("#bback").attr("active",e),t("#bback").attr("back",s),t("#bback").unbind("click"),t("#bback").bind("click",function(){window.getFlow().back(s)})}else t("#bback").css("visibility","hidden"),t("#bback").unbind("click")}},toSwitch:function(e,i,n){var s=this.getStep(e);if(null!=s&&void 0!==s){var a=this.getActive(),o=this.execExpress(a.name,s.expression,s["default"]);a=null;var r=null;t.each(s.cases,function(t){if(this.value==t)return r=t,!0},[o]);var l=null;try{l=null==r?s.cases[s["default"]].nextstep:s.cases[r].nextstep}catch(u){return alert("bad switch config,at "+e),-1}if(null==l||void 0===l)return alert("bad switch config,at "+e),-1;this.next(l,i,n)}},getActive:function(){var t=this.getStep(this.active);return null==t||void 0===t?(alert("the flow has stopped"),null):t},getStep:function(e){if(e&&"string"==typeof e){var i=null;return t.each(this.steps,function(t){if(this.name==t)return i=this,!0},[e]),i}return this.steps[e]},getStepFrame:function(e){return t("#"+e)[0].contentWindow.window.Wade},showImage:function(){t("div[class*=c_flow]").css("display",0==this.imgstatus?"":"none"),this.imgstatus=0==this.imgstatus?1:0,this.setAutoHeight()},autoSize:function(){return document.body.offsetHeight-t("div[class=c_guideStep]")[0].offsetHeight-t("div[class=c_flow]")[0].offsetHeight-t("div[class=c_guideSubmit]")[0].offsetHeight},setAutoHeight:function(){var e=this.autoSize();t.each(this.steps,function(i,n){var s=n.name;if("begin"!=s||"end"!=s){var a=t("#"+s);a.length>0&&a.attr("src")&&""!=a.attr("src")&&a.attr("height")&&"0"!=a.attr("height")&&a.css("height",e)}})},getBackStep:function(){return this.getStep(t("#bback").attr("back"))},getSubmitData:function(){var e="",i=window.getFlow();return this.gostep.eachKey(function(n,s){var a=i.getStep(n),o=i.getStepFrame(n);if(o){var r=a.submitdata;if(r){var l,u;t.each(r.split(","),function(i,n){l=t.trim(n),u=o("#"+l),u.length&&(u.isNodeName("input")||u.isNodeName("textarea")||u.isNodeName("select"))?e+="&"+l+"="+encodeURIComponent(u.val()===undefined?"":u.val()):e+="&"+o.ajax.buildPostData(l)}),u=null}}}),e},cleanup:function(){t("#flowguide").html(""),e.append(t("#flowguide"),{name:"begin",index:"0",desc:"开始"}),t.each(this.steps,function(e,i){t("#"+i.name).attr("src","")}),this.id=null,this.steps=null,this.imgstatus=null,this.gostep=null},initFlow:function(){var e=this.getStep("begin");null!=e&&void 0!==e&&(t.each(this.steps,function(){t("#"+this.name).attr("src","about:blank")}),t("#restart")&&t("#restart").length>0&&(t.appendContextMenu(t("#restart"),null,n,200,"pageflow_restart_toolTip"),this.setRestartButton()),this.gostep.put(e.name,e),this.active=e.name,this.curStep=e.name,this.setGuide(0),this.next(e.nextstep),this.setMonitor(!0))},setRestartButton:function(){t("#restart").bind("click",function(){t("#pageflow_restart_toolTip").css("display","none"),window.getFlow().cleanup(),window.location.reload(!0)}),t("#pageflow_restart__toolTip_delete").bind("click",function(){t("#restart").unbind("mouseover"),t("#restart").unbind("mouseout"),t("#pageflow_restart_toolTip").css("display","none")}),t("#pageflow_restart_toolTip").bind("mouseover",function(){window.pageFlow_toolTip_mouseover=!0}),t("#pageflow_restart_toolTip").bind("mouseout",function(){window.pageFlow_toolTip_mouseover=!1;var e=setTimeout(function(){window.pageFlow_toolTip_mouseover||window.pageFlow_restart_mouseover||t("#pageflow_restart_toolTip").css("display","none"),e&&clearTimeout(e)},100)}),t("#restart").bind("mouseover",function(){if(1!=window.pageFlow_restart_mouseover){window.pageFlow_restart_mouseover=!0;var e=window.getFlow().autoSize(),i=t.initPosition(t("#restart"),200,"pageflow_restart_toolTip",null,null,e);t("#pageflow_restart_toolTip").css("top",i.topPx+"px"),t("#pageflow_restart_toolTip").css("left",i.leftPx+"px"),t("#pageflow_restart_tipPointer").css("left",i.leftPx+"px"),t("#pageflow_restart_toolTip").css("display","block")}}),t("#restart").bind("mouseout",function(){window.pageFlow_restart_mouseover=!1;var e=setTimeout(function(){window.pageFlow_toolTip_mouseover||window.pageFlow_restart_mouseover||t("#pageflow_restart_toolTip").css("display","none"),e&&clearTimeout(e)},100)})},next:function(e,i,n){e||(e=t("#bnext").attr("next"));var s=this.getActive(),a="";if(1!=n){var o=this.getStepFrame(this.active);if(null!=o){var r=o("#"+s.nextbutton);if(r.length>0){if("true"!=s.nexttrigger){if(!1===this.stepChange(i))return;var l=r.triggerHandler("click"),u=r.attr("donext");if(0==l||u&&"false"==u)return;s.nexttrigger="true"}var c=r.attr("nextparams");c&&(a="&"+c),c=null}}}if(!1!==this.stepChange(i)){this.setShowPage(this.active);var h=this.getStep(e);if(null!=h&&void 0!==h){if("page"==h.subflow){if(1!=h.hasOpen)return window.openNav&&window.openNav(h.desc,h.page,h.listener,a,h.subsys),void(h.hasOpen=!0);h=this.getStep(h.nextstep),e=h.name}if("switch"==h.tagname)return void this.toSwitch(e,i,n);this.gostep.put(h.name,h),this.setGuide(e,!1),this.setFlow(e),"about:blank"!=t("#"+h.name).attr("src")?this.setButton(e):this.setButton(e,!0),this.setFrame(e,a),this.setMonitor(!0),this.active=e,this.curStep=e,this.setAutoHeight()}}},back:function(e,i){e||(e=t("#bback").attr("back"));var n=this.getStep(e);if(null!=n&&void 0!==n&&"begin"!==n.name&&"end"!==n.name){var s=this.getActive();if(1!=i){var a=this.getStepFrame(this.active);if(null!=a){var o=a("#"+s.backbutton);if(o.length>0){if(0==o.triggerHandler("click"))return}}}n.nexttrigger="",this.gostep.removeKey(this.active),this.setGuide(e),this.setFlow(e),this.setButton(e),this.setMonitor(!1),this.setFrame(e,""),this.active=e,this.curStep=e,this.setAutoHeight()}},cancel:function(){alert("close the window!")},submit:function(){t.disabledButton("bnext",!0);var e=this.getActive(),n=this.getStepFrame(e.name);if(null!=n){var s=n("#"+e.nextbutton);if(s.length>0){if(!1===this.stepChange())return;if(!s.triggerHandler("click"))return void t.disabledButton("bnext",!1)}}if(n=null,!1!==this.stepChange()){var a="",o=window.getFlow();this.gostep.eachKey(function(e,i){var n=o.getStep(e),s=o.getStepFrame(e);if(s){var r=n.submitdata;if(r){var l,u;t.each(r.split(","),function(e,i){l=t.trim(i),u=s("#"+l),u.val()?a+="&"+l+"="+encodeURIComponent(u.val()):a+="&"+s.ajax.buildPostData(l)}),u=null}}}),t.isFunction(window.flowSubmit)?window.flowSubmit():t.ajax.post(i,"submit",a,null,function(e){t.disabledButton("bnext",!1),alert(t.lang["view.web.comp.pageflow.submit"]),window.getFlow().cleanup(),window.location.reload(!0)},function(e,i){t.disabledButton("bnext",!1),alert(i)},function(){t.disabledButton("bnext",!1),alert(t.lang["view.web.comp.pageflow.busy"])})}},stepChange:function(e){var i=this.getChange(),n=this.activeFrames.slice(this.activeFrames.length-1)[0];if(1!=e){if(i&&i!=n&&(t("#guide_"+i).attr("monitor","{"+this.getStepMonitor(i)+"}"),window.confirm(t.lang["view.web.comp.pageflow.confirm"])))return this.reset(i),this.setShowPage(i),t("#bnext").triggerHandler("click"),!1}else i&&i!=n&&i==this.curStep&&t("#guide_"+this.curStep).attr("monitor","{"+this.getStepMonitor(this.curStep)+"}");return!0},isFilishStep:function(){return this.isFilish}},t.pageflow.fn.construct.prototype=t.pageflow.fn}}(Wade);