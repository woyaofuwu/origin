/*!
 * export component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(s,p,d){"use strict";if(s&&"undefined"==typeof s.Export){Array.prototype.splice;var u="undefined"!=typeof s.hasTouch?s.hasTouch:"ontouchstart"in p,i=u?"touchstart":"mousedown",f=s.os.phone||!0===s.ratioPhone,c=null,g=function(e,t){var o=this;o.el=e&&1==e.nodeType?e:d.getElementById(e),o.el&&o.el.nodeType&&(o.id=s.attr(o.el,"id"))&&(t&&s.isObject(t)&&s.extend(o,t),s.attr(o.el,"x-wade-uicomponent")||s.attr(o.el,"x-wade-uicomponent","export"),o._init(),o.constructor.call(o))};g.prototype=s.extend(new s.UIComponent,{setParams:function(e){e&&s.isString(e)&&(this.params=e)},buildParams:function(e){var t=this,o=[];return o.push("rpcSessionId="+t.rpcSessionId),o.push("pushMode="+t.pushMode),o.push("config="+(t.configFile?t.configFile:"")),o.push("ftpSite="+(t.ftpCode?t.ftpCode:"")),o.push("filePath="+(t.filePath?t.filePath:"export")),o.push("fileId="+(t.file?t.file.fileId:"")),o.push("fileType="+(t.fileType?t.fileType:"")),o.push("model="+(t.model?t.model:"")),o.push("posX="+(t.posX?t.posX:"")),o.push("posY="+(t.posY?t.posY:"")),o.push("fileSerializeId="+(t.fileSerializeId?t.fileSerializeId:"")),o.push("taskId="+(t.taskId?t.taskId:"")),o.push("serviceName="+(t.taskId?t.taskId:"")),o.push("listenerMethod="+(e||"")),o.push("fileName="+encodeURIComponent(t.fileName)),s.ajax.buildSubmitData(t.cond,o.join("&")+(t.params&&s.isString(t.params)?"&"+t.params:""))},tip:function(e,t){e!=undefined&&(this.tipEl.innerHTML=e),t!=undefined&&(this.tipEl.className=t)},show:function(){var e=this;e.adjust(),e.buttonIcoFold&&(e.buttonIcoFold.className="e_ico-fold");var t=e.floatEl.className?e.floatEl.className:"";(" "+t+" ").indexOf(" c_float-show ")<0&&(e.floatEl.className=s.trim(t+" c_float-show"))},hide:function(){var e=this;e.buttonIcoFold&&(e.buttonIcoFold.className="e_ico-unfold");var t=e.floatEl.className?e.floatEl.className:"";e.floatEl.className=s.trim((" "+t+" ").replace(/ c_float-show /gi," "))},adjust:function(){var e=this;if(!f){var t,o,i=d.body.offsetWidth,n=d.body.offsetHeight,r=e.icoMode?e.buttonIco.getBoundingClientRect():e.button.getBoundingClientRect(),l=e.icoMode?e.buttonIco.offsetWidth:e.button.offsetWidth,a=e.icoMode?e.buttonIco.offsetHeight:e.button.offsetHeight,s="buttom",p="right";e.floatEl.style.left="-99999px",e.floatEl.style.top="-99999px",e.floatEl.style.display="block",t=e.floatEl.offsetWidth,o=e.floatEl.offsetHeight,e.floatEl.style.display="",r.top+a+o>n&&(s="top"),r.left+t>i&&(p="left"),e.floatEl.style.top="top"==s?r.top-o+"px":r.top+a+"px",e.floatEl.style.left="left"==p?Math.max(r.left+l-t,0)+"px":r.left+"px"}},getDisabled:function(){return this.disabled},setDisabled:function(e){var o=this;o.disabled=!!e,o.icoMode||(o.button.disabled=o.disabled),setTimeout(function(){var e=o.icoMode?o.buttonIco:o.button,t=e.className?e.className:"";o.disabled?(" "+t+" ").indexOf(" e_dis ")<0&&(e.className=s.trim(t+" e_dis")):(t=s.trim((" "+t+" ").replace(/ e_dis /gi," ")),e.className=t)},0)},destroy:function(){var e=this;e.rpc&&(e.rpc.destroy(),e.rpc=null),e.button=null,e.buttonIco=null,e.buttonIcoFold=null,e.buttonProg=null,e.buttonProgBar=null,e.floatEl=null,e.bgEl=null,e.nameEl=null,e.exportButton=null,e.progEl=null,e.progBarEl=null,e.tipEl=null,e.el=null},_init:function(){var n=this;n.button=d.getElementById(n.id+"_button"),n.buttonIco=d.getElementById(n.id+"_button_icoexp"),n.buttonIcoFold=s(n.button).children("span.e_ico-unfold:first")[0],n.buttonProg=s(n.button).children("span.e_buttonProgress:first")[0],n.buttonProgBar=s(n.buttonProg).children("span.e_buttonBar:first")[0],n.floatEl=d.getElementById(n.id+"_float"),n.bgEl=s(n.floatEl).children("div.bg:first")[0];var e=s(n.floatEl).children("div.content:first"),t=e.children("div:first"),o=t.children("span.e_mix:first");n.nameEl=o.children("input[type=text]:first")[0],n.exportButton=o.find("span.e_ico-export:first").parent("button:first")[0],n.progEl=o.children("span.e_mixProgress:first")[0],n.progBarEl=s(n.progEl).children("span.e_mixBar:first")[0],n.tipEl=t.children("div:last")[0],o=t=e=null,n.fileTypes&&(n.fileTypes=s.FileTransfer.fileTypes(n.fileTypes)),n.rpcSessionId=s.expando+"_"+s.rand(1e6)+"_"+n.id,n.disabled&&n.setDisabled(!0),n.tip(s.lang.get("ui.component.export.tip.input-filename")),s(n.icoMode?n.buttonIco:n.button).tap(function(){n.disabled||((" "+n.floatEl.className+" ").indexOf(" c_float-show ")<0?n.show():n.hide())}),s(n.bgEl).bind(i,function(){n.hide()}),s(n.exportButton).tap(function(){if(!n.disabled&&!0!==n.exporting){var e=s.trim(n.nameEl.value);if(e&&-1<e.indexOf(".")&&(e=e.substring(0,e.indexOf("."))),e){var t=s("#"+n.id+"_filetype_sel").val();n.fileTypes&&s.inArray(t,n.fileTypes)<0?n.tip(s.lang.get("ui.component.export.tip.invalid-filename"),"e_red"):(e=n.fileName=e+t,!1!==s.event.trigger("beforeAction",null,n.el)?(n.fileSerializeId=null,n.buttonProgBar&&(n.buttonProgBar.style.width="0%"),n.progBarEl.style.width="0%",s.attr(n.nameEl,"readOnly",!0),n.tip(s.lang.get("ui.component.export.tip.begin-export",e),""),s.ajaxRequest({url:s.IMPEXP_URL+"?_="+Math.random(),data:n.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e5,success:function(e){if(n.fileSerializeId=e.fileSerializeId,n.messageServer=e.messageServer,n.messageServerType=e.messageServerType?e.messageServerType:null,!0===n.exporting)if("10"==e.progress)n.tip(s.lang.get("ui.component.export.tip.export-started"));else{if(!n.fileSerializeId&&"error"==e.status)return n.exporting=!1,n.buttonProgBar&&(n.buttonProgBar.style.width="0%"),n.progBarEl.style.width="0%",void n.tip(e.hint,"e_red");n.buttonProgBar&&(n.buttonProgBar.style.width=e.progress+"%"),n.progBarEl.style.width=e.progress+"%",n.tip(s.lang.get("ui.component.export.tip.exporting",e.progress+"%",n.fileName))}1==n.pushMode?n.messageServer&&!n.rpc&&(n.rpc=new s.RPC({address:n.messageServer,type:n.messageServerType,session:"&sessionId="+n.rpcSessionId,message:function(e){if(e&&s.isObject(e))if("prog"!=e.STATUS){if(n.exporting=!1,"ok"==e.STATUS){n.buttonProgBar&&(n.buttonProgBar.style.width="100%"),n.progBarEl.style.width="100%";var t=n.downUrl=e.DOWNLOAD_URL,o=s.lang.get("ui.component.export.tip.export-complete");t&&(o+='&nbsp;<a href="#nogo" ontap="$.FileTransfer.download(\''+t+'\')">[<span class="e_ico-download"></span> '+s.lang.get("ui.component.export.tip.export-file-download")+"]</a>"),n.tip(o,"")}else"error"==e.STATUS&&(n.buttonProgBar&&(n.buttonProgBar.style.width="0%"),n.progBarEl.style.width="0%",n.tip(e.ERROR_INFO,"e_red"));s.attr(n.nameEl,"readOnly",!1),s.event.trigger("afterAction",e.STATUS,n.el)}else if(e.PROG){var i=-1<(""+e.PROG).indexOf("%")?e.PROG:e.PROG+"%";n.buttonProgBar&&(n.buttonProgBar.style.width=i),n.progBarEl.style.width=i,n.tip(s.lang.get("ui.component.export.tip.exporting",i,n.fileName))}}}),n.rpc.open()):n.timer=p.setInterval(function(){n.fileSerializeId?s.ajaxRequest({url:s.IMPEXP_URL+"?_="+Math.random(),data:n.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(e){if(e&&s.isObject(e)){if("100"==e.progress||"error"==e.status){if(p.clearInterval(n.timer),n.exporting=!1,"ok"==e.status){n.buttonProgBar&&(n.buttonProgBar.style.width="100%"),n.progBarEl.style.width="100%";var t=n.downUrl=e.downloadUrl,o=s.lang.get("ui.component.export.tip.export-complete");t&&(o+='&nbsp;<a href="#nogo" ontap="$.FileTransfer.download(\''+t+'\')">[<span class="e_ico-download"></span> '+s.lang.get("ui.component.export.tip.export-file-download")+"]</a>"),n.tip(o,"")}else"error"==e.status&&(n.buttonProgBar&&(n.buttonProgBar.style.width="0%"),n.progBarEl.style.width="0%",n.tip(e.hint,"e_red"));s.attr(n.nameEl,"readOnly",!1),s.event.trigger("afterAction",e.status,n.el)}}else p.clearInterval(n.timer)},error:function(e,t,o){p.clearInterval(n.timer),n.exporting=!1,n.tip(s.lang.get("ui.component.export.tip.export-faild",t),"e_red")}}):p.clearInterval(n.timer)},3e3)},error:function(e,t,o){n.exporting=!1,n.tip(s.lang.get("ui.component.export.tip.export-faild",t),"e_red")}}),n.exporting=!0):n.hide())}}})}}),s(function(){s(d.body).bind(i,function(e){e.originalEvent&&(e=e.originalEvent);var t,o=(t=e,u&&t.touchs&&t.touchs.length?t.touchs[0].target:t.target?t.target:t.srcElement);if(o&&o.nodeType){for(var i,n,r=0,l=o,a=!1;l&&l.nodeType&&l!=d.body&&r<50&&((i=s.attr(l,"id"))&&(n=i.substring(0,i.indexOf("_")),(s.nodeName(l,"button")||-1<(""+l.className).indexOf("e_ico-export"))&&n?a=p[n]&&p[n]instanceof g:s.nodeName(l,"div")&&-1<(" "+l.className+" ").indexOf(" c_float ")&&n&&(a=p[n]&&p[n]instanceof g)),1!=a);)l=l.parentNode,r++;c&&(!a||a&&n!=c)&&p[c].hide(),c=a?n:null}}),s(p).bind("onorientationchange"in p?"orientationchange":"resize",function(){c&&p[c]&&(p[c].hide(),c=null)})}),p.Export=s.Export=g}}(window.Wade,window,document);