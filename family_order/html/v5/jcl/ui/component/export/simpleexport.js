/*!
 * simple export component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(l,s,n){"use strict";if(l&&"undefined"==typeof l.Export){Array.prototype.splice;var e=function(e,t){var i=this;i.el=e&&1==e.nodeType?e:n.getElementById(e),i.el&&i.el.nodeType&&(i.id=l.attr(i.el,"id"))&&(t&&l.isObject(t)&&l.extend(i,t),l.attr(i.el,"x-wade-uicomponent")||l.attr(i.el,"x-wade-uicomponent","simpleexport"),i._init(),i.constructor.call(i))};e.prototype=l.extend(new l.UIComponent,{setParams:function(e){e&&l.isString(e)&&(this.params=e)},buildParams:function(e){var t=this,i=[];return i.push("rpcSessionId="+t.rpcSessionId),i.push("pushMode="+t.pushMode),i.push("config="+(t.configFile?t.configFile:"")),i.push("ftpSite="+(t.ftpCode?t.ftpCode:"")),i.push("filePath="+(t.filePath?t.filePath:"export")),i.push("fileId="+(t.file?t.file.fileId:"")),i.push("fileType="+(t.fileType?t.fileType:"")),i.push("model="+(t.model?t.model:"")),i.push("posX="+(t.posX?t.posX:"")),i.push("posY="+(t.posY?t.posY:"")),i.push("fileSerializeId="+(t.fileSerializeId?t.fileSerializeId:"")),i.push("taskId="+(t.taskId?t.taskId:"")),i.push("serviceName="+(t.taskId?t.taskId:"")),i.push("listenerMethod="+(e||"")),i.push("fileName="+encodeURIComponent(t.fullFileName)),l.ajax.buildSubmitData(t.cond,i.join("&")+(t.params&&l.isString(t.params)?"&"+t.params:""))},tip:function(e,t){e!=undefined&&(this.el.value=e),t!=undefined&&(this.el.className="e_left "+t)},getDisabled:function(){return this.disabled},setDisabled:function(e){var t=this;t.disabled=!!e,t.el.disabled=t.disabled,setTimeout(function(){var e=t.span.className?t.span.className:"";t.disabled?(" "+e+" ").indexOf(" e_dis ")<0&&(t.span.className=l.trim(e+" e_dis")):(e=l.trim((" "+e+" ").replace(/ e_dis /gi," ")),t.span.className=e)},0)},destroy:function(){var e=this;e.rpc&&(e.rpc.destroy(),e.rpc=null),e.span=null,e.btnReset=null,e.btnDownload=null,e.btnExport=null,e.progEl=null,e.progBarEl=null,e.el=null},_init:function(){var n=this;n.span=l(n.el).parent("span.e_mix:first")[0],n.btnReset=l(n.span).find("span.e_ico-reset:first").parent("button")[0],n.btnDownload=l(n.span).children("span.e_ico-download:first")[0],n.btnExport=l(n.span).find("span.e_ico-export:first").parent("button")[0],n.progEl=l(n.span).children("span.e_mixProgress:first")[0],n.progBarEl=l(n.progEl).children("span.e_mixBar:first")[0],n.fileTypes&&(n.fileTypes=l.FileTransfer.fileTypes(n.fileTypes)),n.rpcSessionId=l.expando+"_"+l.rand(1e6)+"_"+n.id,setTimeout(function(){l.attr(n.btnDownload,"tip",l.lang.get("ui.component.simpleexport.tip.export-file-download"))},0),l(n.btnReset).tap(function(){n.disabaled||!0===n.exporting||(l.attr(n.el,"readOnly",null),n.btnReset.style.display="none",n.btnDownload.style.display="none",n.btnExport.style.display="",n.progBarEl.style.width="0%",n.el.value=n.fileName?n.fileName:"",n.tip(n.defaultTip,"e_black-light"))}),l(n.btnDownload).tap(function(){n.disabaled||!0===n.exporting||n.downUrl&&s.open(n.downUrl+"&_="+Math.random(),"_new_download_win","height=40,width=100,top=0,left=0,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no")}),l(n.btnExport).tap(function(){if(!n.disabaled&&!0!==n.exporting){var t=n.fileName=n.el.value;if(t&&l.trim(t)){var e=l("#"+n.id+"_filetype_sel").val();n.fileTypes&&l.inArray(e,n.fileTypes)<0?n.tip(l.lang.get("ui.component.simpleexport.tip.invalid-filename"),"e_red"):(n.fullFileName=t+e,!1!==l.event.trigger("beforeAction",null,n.el)&&(n.fileSerializeId=null,l.attr(n.el,"readOnly",!0),n.tip(l.lang.get("ui.component.simpleexport.tip.begin-export",t)),l.ajaxRequest({url:l.IMPEXP_URL+"?_="+Math.random(),data:n.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(e){if(n.fileSerializeId=e.fileSerializeId,n.messageServer=e.messageServer,n.messageServerType=e.messageServerType?e.messageServerType:null,!0===n.exporting)if("10"==e.progress)n.tip(l.lang.get("ui.component.simpleexport.tip.export-started"));else{if(!n.fileSerializeId&&"error"==e.status)return n.exporting=!1,n.progBarEl.style.width="0%",void n.tip(e.hint,"e_red");n.progBarEl.style.width=e.progress+"%",n.tip(l.lang.get("ui.component.simpleexport.tip.exporting",e.progress,t))}1==n.pushMode?n.messageServer&&!n.rpc&&(n.rpc=new l.RPC({address:n.messageServer,type:n.messageServerType,session:"&sessionId="+n.rpcSessionId,message:function(e){if(e&&l.isObject(e))if("prog"!=e.STATUS){if(n.exporting=!1,n.btnReset.style.display="",n.btnExport.style.display="none","ok"==e.STATUS)n.progBarEl.style.width="100%",(n.downUrl=e.DOWNLOAD_URL)&&(n.btnDownload.style.display=""),n.tip(l.lang.get("ui.component.simpleexport.tip.export-complete"),"e_black-light");else"error"==e.STATUS&&(n.progBarEl.style.width="0%",n.tip(e.ERROR_INFO,"e_red"));l.event.trigger("afterAction",e.STATUS,n.el)}else if(e.PROG){var t=-1<(""+e.PROG).indexOf("%")?e.PROG:e.PROG+"%";n.progBarEl.style.width=t,n.tip(l.lang.get("ui.component.simpleexport.tip.exporting",t,n.fileName))}}}),n.rpc.open()):n.timer=s.setInterval(function(){n.fileSerializeId?l.ajaxRequest({url:l.IMPEXP_URL+"?_="+Math.random(),data:n.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(e){if(e&&l.isObject(e)){if("100"==e.progress||"error"==e.status){if(s.clearInterval(n.timer),n.exporting=!1,n.btnReset.style.display="",n.btnExport.style.display="none","ok"==e.status)n.progBarEl.style.width="100%",(n.downUrl=e.downloadUrl)&&(n.btnDownload.style.display=""),n.tip(l.lang.get("ui.component.simpleexport.tip.export-complete"),"e_black-light");else"error"==e.status&&(n.progBarEl.style.width="0%",n.tip(e.hint,"e_red"));l.event.trigger("afterAction",e.status,n.el)}}else s.clearInterval(n.timer)},error:function(e,t,i){s.clearInterval(n.timer),n.exporting=!1,n.btnReset.style.display="",n.btnExport.style.display="none",n.tip(l.lang.get("ui.component.simpleexport.tip.export-faild",t),"e_red")}}):s.clearInterval(n.timer)},3e3)},error:function(e,t,i){n.exporting=!1,n.btnReset.style.display="",n.btnExport.style.display="none",n.tip(l.lang.get("ui.component.simpleexport.tip.export-faild",t),"e_red")}}),n.exporting=!0))}}})}}),s.SimpleExport=l.SimpleExport=e}}(window.Wade,window,document);