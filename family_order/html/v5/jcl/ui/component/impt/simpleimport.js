/*!
 * simple import component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(n,o,l){"use strict";if(n&&"undefined"==typeof n.Import){Array.prototype.splice;var e=function(e,t){var i=this;i.el=e&&1==e.nodeType?e:l.getElementById(e),i.el&&i.el.nodeType&&(i.id=n.attr(i.el,"id"))&&(t&&n.isObject(t)&&n.extend(i,t),n.attr(i.el,"x-wade-uicomponent")||n.attr(i.el,"x-wade-uicomponent","simpleimport"),i._init(),i.constructor.call(i))};e.prototype=n.extend(new n.UIComponent,{setParams:function(e){e&&n.isString(e)&&(this.params=e)},buildParams:function(e){var t=this,i=[];return i.push("rpcSessionId="+t.rpcSessionId),i.push("pushMode="+t.pushMode),i.push("config="+(t.configFile?t.configFile:"")),i.push("ftpSite="+(t.ftpCode?t.ftpCode:"")),i.push("filePath="+(t.filePath?t.filePath:"import")),i.push("fileId="+(t.file?t.file.fileId:"")),i.push("fileName="+(t.file?encodeURIComponent(t.file.name):"")),i.push("fileType="+(t.fileType?t.fileType:"")),i.push("model="+(t.model?t.model:"")),i.push("posX="+(t.posX?t.posX:"")),i.push("posY="+(t.posY?t.posY:"")),i.push("txtSplit="+(t.txtSplit?t.txtSplit:"")),i.push("fileSerializeId="+(t.fileSerializeId?t.fileSerializeId:"")),i.push("taskId="+(t.taskId?t.taskId:"")),i.push("serviceName="+(t.taskId?t.taskId:"")),i.push("listenerMethod="+(e||"")),n.ajax.buildSubmitData(t.cond,i.join("&")+(t.params&&n.isString(t.params)?"&"+t.params:""))},tip:function(e,t){e!=undefined&&(this.nameEl.value=e),t!=undefined&&(this.nameEl.className=t)},getDisabled:function(){return this.disabled},setDisabled:function(e){var t=this;t.disabled=!!e,t.nameEl.disabled=t.disabled,setTimeout(function(){var e=t.span.className?t.span.className:"";t.disabled?(" "+e+" ").indexOf(" e_dis ")<0&&(t.span.className=n.trim(e+" e_dis")):(e=n.trim((" "+e+" ").replace(/ e_dis /gi," ")),t.span.className=e)},0)},destroy:function(){var e=this;if(e.rpc&&(e.rpc.destroy(),e.rpc=null),e.file){for(var t in e.file)delete e.file[t];e.file=null}e.swfup&&(e.swfup.destroy(),e.swfup=null),e.transfer&&(e.transfer.destroy(),e.transfer=null),e.span=null,e.nameEl=null,e.fileFormEl=null,e.fileEl=null,e.btnDownload=null,e.btnBrowser=null,e.btnImport=null,e.progEl=null,e.progBarEl=null,e.el=null,e.defaultTip=null},_init:function(){var l=this;l.url=n.FILE_UPLOAD_URL+(l.ftpCode?"&ftpSite="+l.ftpCode:"")+(l.filePath?"&filePath="+l.filePath:""),n.redirect&&n.redirect.parseUrl&&(l.url=n.redirect.parseUrl(l.url)),l.span=n(l.el).parent("span.e_mix:first")[0],l.nameEl=n(l.span).children("input[type=text]:first")[0],l.fileFormEl=n(l.span).children("form:first")[0],l.fileEl=n(l.fileFormEl).children("input:first")[0],l.btnDownload=n(l.span).children("span.e_ico-download:first")[0],l.btnBrowser=n(l.span).children("span.e_ico-browse:first")[0],l.btnWidth=l.btnBrowser.offsetWidth,l.btnHeight=l.btnBrowser.offsetHeight,l.btnImport=n(l.span).find("span.e_ico-import:first").parent("button:first")[0],l.progEl=n(l.span).children("span.e_mixProgress:first")[0],l.progBarEl=n(l.progEl).children("span.e_mixBar:first")[0];var e=n.attr(l.nameEl,"id");e||(e=l.id+"_name",n.attr(l.nameEl,"id",e)),n.attr(l.el,"x-visible-element",e),setTimeout(function(){l.templateFile&&n.isString(l.templateFile)&&(l.btnDownload.style.display="",n.attr(l.btnDownload,"tip",n.lang.get("ui.component.simpleimport.tip.tpldownload"))),l.fileTypes&&(l.fileTypes=n.FileTransfer.fileTypes(l.fileTypes),l.fileTypes&&n.attr(l.fileEl,"accept",n.FileTransfer.mimeType(l.fileTypes))),l.fileTypeTip=l.fileTypes&&l.fileTypes.length?n.lang.get("ui.component.simpleimport.tip.support-filetypes",l.fileTypes.join(",")):"",l.fileTypeTip&&n.attr(l.btnBrowser,"tip",l.fileTypeTip),l.rpcSessionId=n.expando+"_"+n.rand(1e6)+"_"+l.id,l.useSwfUpload=n.browser.msie&&n.browser.version<10,1==l.useSwfUpload?(n(l.btnBrowser).append('<span id="'+l.id+'_swfupload_holder"></span>'),l.swfup=new SWFUpload({upload_url:l.url,file_size_limit:l.fileSize,file_types:l.fileTypes&&l.fileTypes.length?(""+l.fileTypes.join(";")).replace(/\./g,"*."):null,flash_url:"v5/jcl/plugins/swfupload/swfupload.swf",flash9_url:"v5/jcl/plugins/swfupload/swfupload_fp9.swf",button_placeholder_id:l.id+"_swfupload_holder",button_width:l.btnWidth,button_height:l.btnHeight,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,file_queued_handler:function(e){if(l.auto&&!1===n.event.trigger("beforeAction",null,l.el))for(var t=this.getStats();0<t.files_queued;)this.cancelUpload(null,!1),t=this.getStats();else l._setFile(e),this.startUpload()},file_queue_error_handler:function(e,t,i){switch(t){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:alert(n.lang.get("ui.component.upload.tip.invalid-filesize")+" "+(e?e.name:""));break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:alert(n.lang.get("ui.component.upload.tip.invalid-filetype")+" "+(e?e.name:""));break;case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:alert(n.lang.get("ui.component.upload.tip.file-num-limit",l.fileLimit))}},upload_start_handler:function(e){l._transferStart(l.file)},upload_progress_handler:function(e,t,i){l._transferProgress(t,i,l.file)},upload_success_handler:function(e,t){l._transferSuccess(n.parseJSON(t),"suc",l.file)},upload_error_handler:function(e,t,i){l._transferError(t,i,l.file)}})):l.transfer=new n.FileTransfer({context:l,url:l.url,start:l._transferStart,success:l._transferSuccess,error:l._transferError,progress:function(e,t){l._transferProgress(e.loaded,e.total,t)}})},0),n(l.btnDownload).tap(function(){l.disabled||!0===l.uploading||!0===l.importing||(l.downUrl?n.FileTransfer.download(l.downUrl+"&_="+Math.random()):l.templateFile&&n.FileTransfer.download(l.templateFile))}),n(l.btnBrowser).tap(function(){if(!l.disabled&&!0!==l.uploading&&!0!==l.importing)if(l.useSwfUpload){var e=swfobject.getFlashPlayerVersion();e&&e.major||alert(n.lang.get("ui.component.swfobject.tip.flashplayer-not-installed"))}else l.fileEl.click()}),n(l.fileEl).bind("change",function(){if(!l.disabled&&!0!==l.uploading&&!0!==l.importing)if(l.auto&&!1===n.event.trigger("beforeAction",null,l.el))l.fileFormEl&&l.fileFormEl.nodeType&&l.fileFormEl.reset();else if(!(l.fileEl.files.length<=0)){var e=l.fileEl.files[0];l._setFile(e),l.file&&!l.useSwfUpload&&(l.downUrl&&(l.downUrl=null,n.attr(l.btnDownload,"tip",n.lang.get("ui.component.simpleimport.tip.tpldownload"))),l.transfer.file=l.file,l.transfer.send(),l.uploading=!0)}}),l.auto||n(l.btnImport).tap(function(){l.disabled||!0===l.uploading||!0===l.importing||!1!==n.event.trigger("beforeAction",null,l.el)&&l._doImport()})},_setFile:function(e){var t=this,i=e.name,l=e.size,r=!0;return t._validateFileType(i)?r&&l>t.fileSize?(r=!1,void t.tip(n.lang.get("ui.component.simpleupload.tip.invalid-filesize"),"e_red")):void(t.file={name:i,size:l,valid:r,fileObject:e}):(r=!1,void t.tip(n.lang.get("ui.component.simpleupload.tip.invalid-filetype"),"e_red"))},_validateFileType:function(e){var t=this;if(!t.fileTypes||!t.fileTypes.length)return!0;var i=n.FileTransfer.extName(e);return i&&n.isString(i)&&-1<n.inArray(i,t.fileTypes)||undefined==i},_transferStart:function(e){this.progBarEl.style.width="0%",this.tip(e.name,"e_black-light")},_transferSuccess:function(e,t,i){var l,r,n=this,o=-1;if(!(e&&e.context&&e.data&&(r=e.data.fileId)))return o=e&&e.context?e.context.x_resultcode:"-1",l=e&&e.context?e.context.x_resultinfo:"",void n._transferError.call(n,o,l,i);n.uploading=!1,i.fileId=n.el.value=r,i.fileObject=null,n.fileFormEl&&n.fileFormEl.nodeType&&n.fileFormEl.reset(),n.progBarEl.style.width="0%",n.tip(i.name),n.auto?n._doImport():n.btnImport.style.display=""},_transferError:function(e,t,i){this.uploading=!1,i.fileObject=null,this.fileFormEl&&this.fileFormEl.reset(),this.tip(n.lang.get("ui.component.simpleimport.tip.upload-faild-info",t||"Status("+e+")"),"e_red")},_transferProgress:function(e,t,i){var l=0<e&&0<t?Math.round(e/t*100):0;100<=l&&(l=99),this.progBarEl.style.width=l+"%",this.tip(n.lang.get("ui.component.simpleimport.tip.uploading",l,i.name))},_doImport:function(){var r=this;r.fileSerializeId=null,r.tip(n.lang.get("ui.component.simpleimport.tip.begin-import",r.file.name)),n.ajaxRequest({url:n.IMPEXP_URL+"?_="+Math.random(),data:r.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(e){if(r.fileSerializeId=e.fileSerializeId,r.messageServer=e.messageServer,r.messageServerType=e.messageServerType?e.messageServerType:null,!0===r.importing)if("10"==e.progress)r.tip(n.lang.get("ui.component.simpleimport.tip.import-started"));else{if(!r.fileSerializeId&&"error"==e.status)return r.importing=!1,r.progBarEl.style.width="0%",void r.tip(e.hint,"e_red");r.progBarEl.style.width=e.progress+"%",r.tip(n.lang.get("ui.component.simpleimport.tip.importing",e.progress+"%",r.file.name))}1==r.pushMode?r.messageServer&&!r.rpc&&(r.rpc=new n.RPC({address:r.messageServer,type:r.messageServerType,session:"&sessionId="+r.rpcSessionId,message:function(e){if(e&&n.isObject(e)){if(r.importing=!1,r.btnImport.style.display="none","ok"==e.STATUS){r.progBarEl.style.width="100%";var t=e.ERROR_INFO;(r.downUrl=e.DOWNLOAD_URL)&&n.attr(r.btnDownload,"tip",n.lang.get("ui.component.simpleimport.tip.faild-data-download"));var i=n.lang.get("ui.component.simpleimport.tip.import-complete");if(/^[0-9,]+$/.test(t)){var l=t.split(",");i+=" "+n.lang.get("ui.component.simpleimport.tip.import-count",l[0],l[1])}else i=t;r.tip(i,"e_black-light")}else"error"==e.STATUS&&(r.progBarEl.style.width="0%",r.tip(e.ERROR_INFO,"e_red"));n.event.trigger("afterAction",e.STATUS,r.el)}}}),r.rpc.open()):r.timer=o.setInterval(function(){r.fileSerializeId?n.ajaxRequest({url:n.IMPEXP_URL+"?_="+Math.random(),data:r.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(e){if(e&&n.isObject(e)){if("100"==e.progress||"error"==e.status){if(o.clearInterval(r.timer),r.importing=!1,r.btnImport.style.display="none","ok"==e.status){r.progBarEl.style.width="100%";var t=e.hint;(r.downUrl=e.downloadUrl)&&n.attr(r.btnDownload,"tip",n.lang.get("ui.component.simpleimport.tip.faild-data-download"));var i=n.lang.get("ui.component.simpleimport.tip.import-complete");if(/^[0-9,]+$/.test(t)){var l=t.split(",");i+=" "+n.lang.get("ui.component.simpleimport.tip.import-count",l[0],l[1])}else i=t;r.tip(i,"e_black-light")}else"error"==e.status&&(r.progBarEl.style.width="0%",r.tip(e.hint,"e_red"));n.event.trigger("afterAction",e.status,r.el)}}else o.clearInterval(r.timer)},error:function(e,t,i){o.clearInterval(r.timer),r.importing=!1,r.tip(n.lang.get("ui.component.simpleimport.tip.import-faild",t),"e_red")}}):o.clearInterval(r.timer)},3e3)},error:function(e,t,i){r.importing=!1,r.tip(n.lang.get("ui.component.simpleimport.tip.import-faild",t),"e_red")}}),r.importing=!0}}),o.SimpleImport=n.SimpleImport=e}}(window.Wade,window,document);