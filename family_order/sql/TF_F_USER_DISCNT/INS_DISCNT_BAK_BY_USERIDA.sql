INSERT INTO  TF_B_TRADE_DISCNT_BAK(TRADE_ID,ACCEPT_MONTH,PARTITION_ID,USER_ID,USER_ID_A,PRODUCT_ID,PACKAGE_ID,DISCNT_CODE,SPEC_TAG,RELATION_TYPE_CODE,INST_ID,CAMPN_ID,START_DATE,END_DATE,UPDATE_TIME, UPDATE_STAFF_ID,UPDATE_DEPART_ID,REMARK,RSRV_NUM1,RSRV_NUM2,RSRV_NUM3,RSRV_NUM4,RSRV_NUM5,RSRV_STR1,RSRV_STR2,RSRV_STR3,RSRV_STR4,RSRV_STR5,RSRV_DATE1,RSRV_DATE2,RSRV_DATE3,RSRV_TAG1,RSRV_TAG2,RSRV_TAG3)
SELECT TO_NUMBER(:TRADE_ID),TO_NUMBER(SUBSTR(:TRADE_ID,5,2)),PARTITION_ID,USER_ID,USER_ID_A,PRODUCT_ID,PACKAGE_ID, DISCNT_CODE,SPEC_TAG,RELATION_TYPE_CODE,INST_ID,CAMPN_ID,START_DATE,END_DATE,UPDATE_TIME,UPDATE_STAFF_ID,UPDATE_DEPART_ID,REMARK,RSRV_NUM1,RSRV_NUM2,RSRV_NUM3, RSRV_NUM4, RSRV_NUM5,RSRV_STR1,RSRV_STR2,RSRV_STR3,RSRV_STR4,RSRV_STR5,RSRV_DATE1,RSRV_DATE2,RSRV_DATE3,RSRV_TAG1,RSRV_TAG2,RSRV_TAG3
 FROM TF_F_USER_DISCNT A
  WHERE A.USER_ID_A = TO_NUMBER(:USER_ID_A)
     AND A.USER_ID != TO_NUMBER(:USER_ID_B)
     AND A.SPEC_TAG = '2'
     AND A.END_DATE > A.START_DATE
     AND A.END_DATE = (SELECT MAX(B.END_DATE)
                         FROM TF_F_USER_DISCNT B
                        WHERE B.USER_ID_A = TO_NUMBER(:USER_ID_A)
                          AND B.SPEC_TAG = '2'
                          AND B.END_DATE < SYSDATE)
     AND NOT EXISTS
   (SELECT 1 FROM TF_B_TRADE_DISCNT_BAK C
           WHERE C.TRADE_ID = :TRADE_ID
             AND C.ACCEPT_MONTH = TO_NUMBER(SUBSTR(:TRADE_ID, 5, 2))
             AND C.INST_ID = A.INST_ID
             AND C.USER_ID_A = TO_NUMBER(:USER_ID_A)
             AND C.DISCNT_CODE = A.DISCNT_CODE
             AND C.USER_ID = A.USER_ID
             AND C.PACKAGE_ID = A.PACKAGE_ID
             AND C.PRODUCT_ID = A.PRODUCT_ID
             AND c.partition_id = a.partition_id)