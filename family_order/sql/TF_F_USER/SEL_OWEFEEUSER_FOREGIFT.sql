SELECT /*+INDEX(A,IDX_TF_F_USER_REMOVETAG)*/ A.CITY_CODE, A.SERIAL_NUMBER, B.CUST_NAME,
       (SELECT /*+INDEX(TF_F_USER_FOREGIFT,PK_TF_F_USER_FOREGIFT)*/ SUM(MONEY)
           FROM TF_F_USER_FOREGIFT
          WHERE USER_ID = A.USER_ID
            AND PARTITION_ID = MOD(A.USER_ID, 10000)) AS MONEY
  FROM TF_F_USER A, TF_F_CUSTOMER B
 WHERE A.CITY_CODE = :AREA_CODE
   AND INSTR(A.USER_STATE_CODESET, :USER_SVC_STATE, 1) > 0
   AND A.REMOVE_TAG = :REMOVE_TAG
   AND A.DESTROY_TIME >= TO_DATE(:START_DATE, 'yyyy-mm-dd')
   AND A.DESTROY_TIME < TO_DATE(:END_DATE, 'yyyy-mm-dd') + 1
   AND A.CUST_ID = B.CUST_ID
   AND B.PARTITION_ID = MOD(A.CUST_ID, 10000)
   AND EXISTS (SELECT /*+INDEX(TF_F_USER_FOREGIFT,PK_TF_F_USER_FOREGIFT)*/ 1
          FROM TF_F_USER_FOREGIFT C
         WHERE C.USER_ID = A.USER_ID
           AND C.PARTITION_ID = MOD(A.USER_ID, 10000)
           AND C.MONEY > 0)
