select * from(select decode(a.bpm_templet_id,'RESOURCECONFIRM','开通勘察单','DIRECTLINEOPEN','开通单','CHANGERESOURCECONFIRM','变更勘察单','DIRECTLINECHANGE','变更开通单','DIRECTLINECHANGESIMPLE','简单场景变更','DIRECTLINECHANGEFEE','资费变更单','DIRECTLINECANCEL','拆机单','其他') SUB_TYPE,a.bpm_templet_id SUB_TYPE_CODE,TOTAL,nvl(UNCHECKIN,0) UNCHECKIN,nvl(CHECKIN,0) CHECKIN,round(decode(total,0,0,nvl(CHECKIN,0)/total),2)*100||'%' CHECKIN_PER from(select a.bpm_templet_id, count(1) total from(select * from TF_B_EOP_SUBSCRIBE t1 union all select * from TF_BH_EOP_SUBSCRIBE t2 where t2.deal_state='2') a where a.bpm_templet_id in ('RESOURCECONFIRM','DIRECTLINEOPEN','CHANGERESOURCECONFIRM','DIRECTLINECHANGE','DIRECTLINECHANGESIMPLE','DIRECTLINECHANGEFEE','DIRECTLINECANCEL') and to_char(a.accept_time,'yyyymmdd')>=to_char(to_date(:BEGIN_DATE,'yyyy-MM-dd'),'yyyymmdd') and to_char(a.accept_time,'yyyymmdd')<=to_char(to_date(:END_DATE,'yyyy-MM-dd'),'yyyymmdd') group by a.bpm_templet_id) a,(select a.bpm_templet_id, count(1) uncheckin from TF_B_EOP_SUBSCRIBE a where a.bpm_templet_id in ('RESOURCECONFIRM','DIRECTLINEOPEN','CHANGERESOURCECONFIRM','DIRECTLINECHANGE','DIRECTLINECHANGESIMPLE','DIRECTLINECHANGEFEE','DIRECTLINECANCEL') and to_char(a.accept_time,'yyyymmdd')>=to_char(to_date(:BEGIN_DATE,'yyyy-MM-dd'),'yyyymmdd') and to_char(a.accept_time,'yyyymmdd')<=to_char(to_date(:END_DATE,'yyyy-MM-dd'),'yyyymmdd') group by a.bpm_templet_id) b,(select a.bpm_templet_id, count(1) checkin from TF_BH_EOP_SUBSCRIBE a where a.deal_state='2' and a.bpm_templet_id in ('RESOURCECONFIRM','DIRECTLINEOPEN','CHANGERESOURCECONFIRM','DIRECTLINECHANGE','DIRECTLINECHANGESIMPLE','DIRECTLINECHANGEFEE','DIRECTLINECANCEL') and to_char(a.accept_time,'yyyymmdd')>=to_char(to_date(:BEGIN_DATE,'yyyy-MM-dd'),'yyyymmdd') and to_char(a.accept_time,'yyyymmdd')<=to_char(to_date(:END_DATE,'yyyy-MM-dd'),'yyyymmdd') group by a.bpm_templet_id) c where a.bpm_templet_id = b.bpm_templet_id(+) and a.bpm_templet_id = c.bpm_templet_id(+) order by decode(a.bpm_templet_id,'RESOURCECONFIRM',1,'DIRECTLINEOPEN',2,'CHANGERESOURCECONFIRM',3,'DIRECTLINECHANGE',4,'DIRECTLINECHANGESIMPLE',5,'DIRECTLINECHANGEFEE',6,'DIRECTLINECANCEL',7,8)) union all select '合计' SUB_TYPE,'TOTAL'SUB_TYPE_CODE,TOTAL,nvl(UNCHECKIN,0) UNCHECKIN,nvl(CHECKIN,0) CHECKIN,round(decode(total,0,0,nvl(CHECKIN,0)/total),2)*100||'%' CHECKIN_PER from(select 'total' bid, count(1) total from (select * from TF_B_EOP_SUBSCRIBE t1 union all select * from TF_BH_EOP_SUBSCRIBE t2 where t2.deal_state='2') a where a.bpm_templet_id in ('RESOURCECONFIRM','DIRECTLINEOPEN','CHANGERESOURCECONFIRM','DIRECTLINECHANGE','DIRECTLINECHANGESIMPLE','DIRECTLINECHANGEFEE','DIRECTLINECANCEL') and to_char(a.accept_time,'yyyymmdd')>=to_char(to_date(:BEGIN_DATE,'yyyy-MM-dd'),'yyyymmdd') and to_char(a.accept_time,'yyyymmdd')<=to_char(to_date(:END_DATE,'yyyy-MM-dd'),'yyyymmdd')) a,(select 'total' bid, count(1) uncheckin from TF_B_EOP_SUBSCRIBE a where a.bpm_templet_id in ('RESOURCECONFIRM','DIRECTLINEOPEN','CHANGERESOURCECONFIRM','DIRECTLINECHANGE','DIRECTLINECHANGESIMPLE','DIRECTLINECHANGEFEE','DIRECTLINECANCEL') and to_char(a.accept_time,'yyyymmdd')>=to_char(to_date(:BEGIN_DATE,'yyyy-MM-dd'),'yyyymmdd') and to_char(a.accept_time,'yyyymmdd')<=to_char(to_date(:END_DATE,'yyyy-MM-dd'),'yyyymmdd')) b,(select 'total' bid, count(1) checkin from TF_BH_EOP_SUBSCRIBE a where a.deal_state='2' and a.bpm_templet_id in ('RESOURCECONFIRM','DIRECTLINEOPEN','CHANGERESOURCECONFIRM','DIRECTLINECHANGE','DIRECTLINECHANGESIMPLE','DIRECTLINECHANGEFEE','DIRECTLINECANCEL') and to_char(a.accept_time,'yyyymmdd')>=to_char(to_date(:BEGIN_DATE,'yyyy-MM-dd'),'yyyymmdd') and to_char(a.accept_time,'yyyymmdd') <=to_char(to_date(:END_DATE, 'yyyy-MM-dd'),'yyyymmdd')) c where a.bid = b.bid(+) and a.bid = c.bid(+)
