SELECT F.CUST_NAME,
       A.SERIAL_NUMBER,
       A.PRODUCT_ID,
       A.PRODUCT_NAME,
       A.PACKAGE_ID,
       A.PACKAGE_NAME,
       A.ACCEPT_DATE,
       D.STAFF_ID TRADE_STAFF_ID,
       D.DEPART_ID TRADE_DEPART_ID,
       D.CITY_CODE TRADE_CITY_CODE
  FROM TF_F_USER_SALE_ACTIVE A, TD_M_STAFF D, TF_F_USER E, TF_F_CUSTOMER F
 WHERE A.PROCESS_TAG = '0'
   AND A.END_DATE > SYSDATE
   AND A.TRADE_STAFF_ID = D.STAFF_ID
   AND A.PRODUCT_ID = :PRODUCT_ID
   AND A.PACKAGE_ID = :PACKAGE_ID
   AND (:TRADE_STAFF_ID_S IS NULL OR
       A.TRADE_STAFF_ID >= TRIM(:TRADE_STAFF_ID_S))
   AND (:TRADE_STAFF_ID_E IS NULL OR
       A.TRADE_STAFF_ID <= TRIM(:TRADE_STAFF_ID_E))
   AND A.Accept_Date between TO_date(:START_DATE, 'yyyy-mm-dd hh24:mi:ss') AND
       TO_date(:END_DATE, 'yyyy-mm-dd hh24:mi:ss')+1
   AND D.END_DATE > SYSDATE
   AND EXISTS (SELECT 1
          FROM TD_S_COMMPARA B
         WHERE B.PARAM_ATTR = 50
           AND B.END_DATE > SYSDATE
           AND B.PARAM_CODE = A.PRODUCT_ID
           AND B.PARA_CODE1 = A.PACKAGE_ID)
   AND NOT EXISTS
 (SELECT 1
          FROM TF_F_USER_SALE_GOODS C
         WHERE C.USER_ID = A.USER_ID
           AND C.PRODUCT_ID = A.PRODUCT_ID
           AND C.PACKAGE_ID = A.PACKAGE_ID
           AND C.RELATION_TRADE_ID = A.RELATION_TRADE_ID
           AND C.RSRV_DATE2 > SYSDATE
           AND C.RES_CODE<> '-1')
   AND A.USER_ID = E.USER_ID
   AND E.CUST_ID = F.CUST_ID
   AND D.CITY_CODE = :TRADE_CITY_CODE
   AND (:TRADE_DEPART_ID IS NULL OR D.DEPART_ID = :TRADE_DEPART_ID)
   ORDER BY A.Accept_Date  ASC