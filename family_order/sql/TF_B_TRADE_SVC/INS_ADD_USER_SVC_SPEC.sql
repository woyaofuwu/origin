INSERT INTO TF_B_TRADE_SVC
  (TRADE_ID,
   ACCEPT_MONTH,
   USER_ID,
   USER_ID_A,
   PRODUCT_ID,
   PACKAGE_ID,
   SERVICE_ID,
   MAIN_TAG,
   INST_ID,
   CAMPN_ID,
   START_DATE,
   END_DATE,
   MODIFY_TAG,
   UPDATE_TIME,
   UPDATE_STAFF_ID,
   UPDATE_DEPART_ID,
   REMARK)
  SELECT TO_NUMBER(:TRADE_ID),
         TO_NUMBER(SUBSTR(:TRADE_ID, 5, 2)),
         TO_NUMBER(:USER_ID),
         -1,
         :PRODUCT_ID,
         (SELECT B.PACKAGE_ID
            FROM TD_B_PRODUCT_PACKAGE A, TD_B_PACKAGE_ELEMENT B
           WHERE A.PACKAGE_ID = B.PACKAGE_ID
             AND A.PRODUCT_ID = TO_NUMBER(:PRODUCT_ID)
             AND B.ELEMENT_TYPE_CODE = 'S'
             AND B.ELEMENT_ID = TO_NUMBER(:SERVICE_ID)
             AND SYSDATE BETWEEN A.START_DATE AND A.END_DATE
             AND SYSDATE BETWEEN B.START_DATE AND A.END_DATE),
         TO_NUMBER(:SERVICE_ID),
         '0',
         TO_NUMBER(:INST_ID),
         NULL,
         TO_DATE(:START_DATE, 'YYYY-MM-DD HH24:MI:SS'),
         TO_DATE(:END_DATE, 'YYYY-MM-DD HH24:MI:SS'),
         :MODIFY_TAG,
         SYSDATE,
         :TRADE_STAFF_ID,
         :TRADE_DEPART_ID,
         :REMARK
    FROM DUAL
   WHERE NOT EXISTS (SELECT 1
            FROM TF_F_USER_SVC
           WHERE USER_ID = TO_NUMBER(:USER_ID)
             AND PARTITION_ID = MOD(TO_NUMBER(:USER_ID), 10000)
             AND SERVICE_ID = TO_NUMBER(:SERVICE_ID)
             AND END_DATE > SYSDATE)
     AND NOT EXISTS
   (SELECT 1
            FROM TF_B_TRADE_SVC
           WHERE TRADE_ID = TO_NUMBER(:TRADE_ID)
             AND ACCEPT_MONTH = TO_NUMBER(SUBSTR(:TRADE_ID, 5, 2))
             AND SERVICE_ID = TO_NUMBER(:SERVICE_ID)
             AND MODIFY_TAG = '0')